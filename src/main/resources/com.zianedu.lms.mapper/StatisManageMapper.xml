<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zianedu.lms.mapper.StatisManageMapper">


    <select id="selectTotalStatisAtMonth" resultType="StatisResultDTO">
        SELECT
            TO_CHAR(INDATE, 'YYYY-MM') as DAY,
            SUM(PRICE_PAY) as PRICE
        FROM
        (
            SELECT
               distinct A.J_KEY, A.PRICE_PAY, A.INDATE, B.TYPE, A.PAY_STATUS, A.PAY_TYPE
            FROM T_ORDER A
            INNER JOIN T_ORDER_GOODS B
            ON A.J_KEY = B.J_KEY
            WHERE 1=1
            AND A.PAY_STATUS = 2
            AND A.PAY_TYPE != 20
            <if test="goodsType > 0">
                AND B.TYPE = #{goodsType}
            </if>
        )
        WHERE TO_CHAR(INDATE, 'YYYY') = #{year}
        GROUP BY TO_CHAR(INDATE, 'YYYY-MM')
        ORDER BY DAY ASC
    </select>

    <select id="selectTotalStatisAtYear" resultType="StatisResultDTO">
       SELECT
            TO_CHAR(INDATE, 'YYYY') as DAY,
            SUM(PRICE_PAY) as PRICE
        FROM
        (
            SELECT
               distinct A.J_KEY, A.PRICE_PAY, A.INDATE, B.TYPE, A.PAY_STATUS, A.PAY_TYPE
            FROM T_ORDER A
            INNER JOIN T_ORDER_GOODS B
            ON A.J_KEY = B.J_KEY
            WHERE 1=1
            AND A.PAY_STATUS = 2
            AND A.PAY_TYPE != 20
            <if test="goodsType > 0">
                AND B.TYPE = #{goodsType}
            </if>

        )
        GROUP BY TO_CHAR(INDATE, 'YYYY')
        ORDER BY DAY ASC
    </select>

    <select id="selectTotalStatisAtYearDay" resultType="StatisResultDTO">
        SELECT
            TO_CHAR(INDATE, 'YYYY-MM-DD') as DAY,
            SUM(PRICE_PAY) as PRICE
        FROM
        (
            SELECT
               distinct A.J_KEY, A.PRICE_PAY, A.INDATE, B.TYPE, A.PAY_STATUS, A.PAY_TYPE
            FROM T_ORDER A
            INNER JOIN T_ORDER_GOODS B
            ON A.J_KEY = B.J_KEY
            WHERE 1=1
            AND A.PAY_STATUS = 2
            AND A.PAY_TYPE != 20
            <if test="goodsType > 0">
                AND B.TYPE = #{goodsType}
            </if>
        )
        WHERE TO_CHAR(INDATE, 'YYYY-MM') = #{month}
        GROUP BY TO_CHAR(INDATE, 'YYYY-MM-DD')
        ORDER BY DAY ASC
    </select>

    <select id="selectTotalStatisAtMonthByPackage" resultType="StatisResultDTO">
        SELECT
            TO_CHAR(INDATE, 'YYYY-MM') as DAY,
            SUM(PRICE_PAY) as PRICE
        FROM
        (
            SELECT
            distinct A.J_KEY, A.PRICE_PAY, A.INDATE, B.TYPE, A.PAY_STATUS, A.PAY_TYPE
            FROM T_ORDER A
            INNER JOIN T_ORDER_GOODS B
            ON A.J_KEY = B.J_KEY
            WHERE 1=1
            AND A.PAY_STATUS = 2
            AND A.PAY_TYPE != 20
            <if test="goodsType > 0">
                AND B.TYPE = #{goodsType}
            </if>
        )
        WHERE TO_CHAR(INDATE, 'YYYY') = #{year}
        GROUP BY TO_CHAR(INDATE, 'YYYY-MM')
        ORDER BY DAY ASC
    </select>

</mapper>
